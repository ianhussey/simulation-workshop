---
title: "Simulate the violation of assumption of homogeneity of variances"
author: "Ian Hussey"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: flatly
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}

# set default chunk options
knitr::opts_chunk$set(message = FALSE,
                      warning = FALSE)

# disable scientific notation
options(scipen = 999) 

```

```{r}

# dependencies
library(dplyr)
library(tidyr)
library(tibble)
library(purrr)
library(janitor)
library(knitr)
library(kableExtra)

```

# Simulating the violation of assumptions of a Student's t-test on statistical significance

```{r}

generate_data <- function(n_control, # the parameters are now function arguments
                          n_intervention,
                          mean_control,
                          mean_intervention,
                          sd_control,
                          sd_intervention) {
  
  data <- 
    bind_rows(
      tibble(condition = "control",
             score = rnorm(n = n_control, mean = mean_control, sd = sd_control)),
      tibble(condition = "intervention",
             score = rnorm(n = n_intervention, mean = mean_intervention, sd = sd_intervention))
    ) 
  
  return(data)
}

analyze_data <- function(data, var_equal) {
  
  res_t_test <- t.test(formula = score ~ condition, 
                       data = data,
                       var.equal = var_equal,
                       alternative = "two.sided")
  
  res <- tibble(p = res_t_test$p.value)
  
  return(res)
}

simulation <- 
  # "using the experiment parameters..."
  expand_grid(n_control = 50,
              n_intervention = c(25, 50),
              mean_control = 0,
              mean_intervention = 0,
              sd_control = 1,
              sd_intervention = c(1, 3),
              var_equal = TRUE,
              iteration = 1:5000) |>
  
  # ...generate data that meets those parameters...
  mutate(generated_data = pmap(list(n_control, 
                                    n_intervention,
                                    mean_control,
                                    mean_intervention,
                                    sd_control,
                                    sd_intervention),
                               generate_data)) |>
  
  # "... then apply the analysis function to the generated data using the parameters relevant to analysis"
  mutate(analysis_results = pmap(list(generated_data,
                                      var_equal), 
                                 analyze_data))

# summarize across iterations
simulation_results <- simulation |>
  unnest(analysis_results) |>
  # ensure all manipulated variables are in the group_by()
  group_by(n_control,
           n_intervention,
           mean_control,
           mean_intervention,
           sd_control,
           sd_intervention,
           var_equal) |>
  summarize(proportion_significant = mean(p < .05), .groups = "drop") |>
  select(mean_control, mean_intervention, sd_control, sd_intervention, n_control, n_intervention, proportion_significant) 

# print table
simulation_results |>
  mutate_if(is.numeric, round_half_up, digits = 2) |>
  kable(align = "r") |>
  kable_classic(full_width = FALSE)

```

# Session info

```{r}

sessionInfo()

```


